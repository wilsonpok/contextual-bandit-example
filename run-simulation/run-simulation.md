Contextual bandit example - run simulation
================

Introduction
------------

We will replay the `EpsilonFirstPolicy` (A/B testing),
`EpsilonGreedyPolicy` (MAB) , and `LinUCBDisjointPolicy` (CB) policies
over this data using the `OfflineDoublyRobustBandit`.

Required inputs
---------------

However, the `OfflineDoublyRobustBandit` requires:

1.  Fitting a model to the data, as in the direct method
2.  Propensities per arm, as in the inverse propensity score method. The
    Doubly Robust Bandit uses the marginal probabilities per arm if
    these are omitted.

### Fit DM model

We fit a logistic regression to each arm, and use it to produce a
predicted reward for each observation for each arm.

    ## # A tibble: 6 x 7
    ##   choice reward      r1      r2      r3      r4      r5
    ##    <dbl>  <dbl>   <dbl>   <dbl>   <dbl>   <dbl>   <dbl>
    ## 1      3      0 0.0271  0.964   0.0188  0.0358  0.0386 
    ## 2      4      0 0.0411  0.0346  0.0366  0.0240  0.0533 
    ## 3      4      0 0.0136  0.0127  0.0117  0.00557 0.00789
    ## 4      4      0 0.00961 0.0156  0.00911 0.0106  0.0122 
    ## 5      3      0 0.0221  0.00597 0.0117  0.0136  0.0192 
    ## 6      2      0 0.0111  0.00682 0.00888 0.00283 0.00836

### Fit IPS probabilities

We could fit a model to predict arm probabilities, but for now we’ll
just default to the marginal probabilities.

Doubly robust evaluation
------------------------

Evaluation policy
-----------------

The policies to be evaluated here are `EpsilonFirstPolicy`,
`EpsilonGreedyPolicy`, and `LinUCBDisjointPolicy`.

    agents <-list(
        Agent$new(EpsilonFirstPolicy$new(epsilon = 0.1, N = horizon), bandit_dr),
        Agent$new(EpsilonGreedyPolicy$new(epsilon = 0.1), bandit_dr),
        Agent$new(LinUCBDisjointPolicy$new(0.01), bandit_dr)
        )

Results
-------

    ## 
    ## Agents:
    ## 
    ##   EpsilonFirst,   EpsilonGreedy,   LinUCBDisjoint
    ## 
    ## Cumulative regret:
    ## 
    ##           agent    t sims cum_regret cum_regret_var cum_regret_sd
    ##    EpsilonFirst 4972   50         NA             NA            NA
    ##   EpsilonGreedy 4972   50         NA             NA            NA
    ##  LinUCBDisjoint 4972   50         NA             NA            NA
    ## 
    ## 
    ## Cumulative reward:
    ## 
    ##           agent    t sims cum_reward cum_reward_var cum_reward_sd
    ##    EpsilonFirst 4972   50   862.5657     4078.55366     63.863555
    ##   EpsilonGreedy 4972   50   857.6562     2940.20610     54.223667
    ##  LinUCBDisjoint 4972   50  2478.6382       42.16934      6.493792
    ## 
    ## 
    ## Cumulative reward rate:
    ## 
    ##           agent    t sims cur_reward cur_reward_var cur_reward_sd
    ##    EpsilonFirst 4972   50  0.1734847    0.820304438   0.012844641
    ##   EpsilonGreedy 4972   50  0.1724972    0.591352796   0.010905806
    ##  LinUCBDisjoint 4972   50  0.4985193    0.008481363   0.001306072

Plots
-----

### Arm choices

![](run-simulation_files/figure-gfm/unnamed-chunk-5-1.png)<!-- -->![](run-simulation_files/figure-gfm/unnamed-chunk-5-2.png)<!-- -->![](run-simulation_files/figure-gfm/unnamed-chunk-5-3.png)<!-- -->

    ## `summarise()` regrouping output by 't', 'choice' (override with `.groups` argument)

![](run-simulation_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

### Cumulative reward

![](run-simulation_files/figure-gfm/unnamed-chunk-7-1.png)<!-- -->

    ## `summarise()` ungrouping output (override with `.groups` argument)

| agent          |   n |
|:---------------|----:|
| EpsilonFirst   |  50 |
| EpsilonGreedy  |  50 |
| LinUCBDisjoint |  50 |

    ## Rows: 745,800
    ## Columns: 116
    ## $ t               <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
    ## $ k               <int> 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,…
    ## $ d               <int> 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100…
    ## $ sim             <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16…
    ## $ choice          <dbl> 4, 2, 1, 5, 4, 4, 3, 4, 4, 4, 1, 1, 1, 5, 4, 2, 1, 5,…
    ## $ reward          <dbl> 0.98251477, 0.01194671, 0.01668626, 0.02238859, 0.961…
    ## $ optimal_arm     <int> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ optimal_reward  <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ propensity      <dbl> 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2…
    ## $ agent           <fct> EpsilonFirst, EpsilonFirst, EpsilonFirst, EpsilonFirs…
    ## $ regret          <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ cum_reward      <dbl> 0.98251477, 0.01194671, 0.01668626, 0.02238859, 0.961…
    ## $ cum_regret      <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
    ## $ X.1             <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
    ## $ X.2             <dbl> 73, 46, 30, 1, 81, 14, 4, 41, 1, 8, 0, 15, 26, 15, 79…
    ## $ X.3             <dbl> 0, 1, 1, 2, 0, 0, 0, 0, 2, 6, 4, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.4             <dbl> 0, 2, 1, 28, 0, 0, 0, 1, 27, 0, 35, 0, 0, 0, 0, 0, 0,…
    ## $ X.5             <dbl> 17, 49, 35, 0, 9, 0, 22, 36, 0, 41, 0, 0, 44, 0, 18, …
    ## $ X.6             <dbl> 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 3, 0,…
    ## $ X.7             <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.8             <dbl> 0, 0, 0, 0, 1, 0, 0, 0, 0, 19, 0, 0, 0, 0, 0, 0, 0, 0…
    ## $ X.9             <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.10            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.11            <dbl> 36, 0, 0, 0, 25, 0, 23, 0, 0, 0, 1, 0, 0, 0, 28, 28, …
    ## $ X.12            <dbl> 0, 0, 0, 0, 0, 4, 0, 0, 0, 2, 0, 4, 0, 5, 0, 0, 0, 0,…
    ## $ X.13            <dbl> 0, 0, 0, 0, 3, 1, 0, 0, 1, 0, 1, 1, 0, 3, 0, 3, 0, 0,…
    ## $ X.14            <dbl> 30, 0, 0, 0, 20, 0, 5, 0, 0, 0, 0, 0, 0, 0, 15, 21, 0…
    ## $ X.15            <dbl> 0, 0, 1, 0, 0, 2, 0, 0, 0, 89, 0, 0, 0, 0, 0, 0, 0, 0…
    ## $ X.16            <dbl> 0, 2, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0,…
    ## $ X.17            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.18            <dbl> 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 3, 0, 5, 0, 0, 1, 0,…
    ## $ X.19            <dbl> 0, 0, 0, 0, 0, 2, 12, 0, 0, 0, 0, 7, 0, 4, 0, 0, 0, 0…
    ## $ X.20            <dbl> 0, 0, 0, 17, 0, 0, 1, 0, 13, 4, 12, 0, 0, 0, 0, 0, 0,…
    ## $ X.21            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.22            <dbl> 2, 0, 0, 24, 2, 10, 0, 0, 22, 0, 23, 9, 0, 5, 1, 2, 0…
    ## $ X.23            <dbl> 0, 0, 0, 0, 0, 6, 9, 0, 0, 0, 0, 17, 0, 4, 0, 0, 0, 0…
    ## $ X.24            <dbl> 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 2, 0, 0, 0, 1, 0, 0, 0,…
    ## $ X.25            <dbl> 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 4, 0, 1, 0, 1, 1, 0, 2,…
    ## $ X.26            <dbl> 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.27            <dbl> 0, 1, 1, 7, 0, 0, 16, 1, 5, 0, 9, 0, 1, 0, 0, 0, 0, 0…
    ## $ X.28            <dbl> 0, 0, 0, 0, 0, 0, 39, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
    ## $ X.29            <dbl> 0, 0, 0, 1, 1, 18, 1, 0, 2, 3, 0, 24, 0, 22, 1, 1, 0,…
    ## $ X.30            <dbl> 0, 0, 0, 0, 2, 30, 1, 0, 0, 10, 0, 18, 0, 27, 1, 0, 0…
    ## $ X.31            <dbl> 0, 14, 13, 0, 0, 0, 0, 6, 0, 0, 0, 0, 9, 0, 0, 0, 5, …
    ## $ X.32            <dbl> 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 2, 0, 3, 0, 0, 0, 0,…
    ## $ X.33            <dbl> 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 3, 0, 2, 0, 0, 0, 1,…
    ## $ X.34            <dbl> 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 3, 0, 2, 0, 0, 0, 0,…
    ## $ X.35            <dbl> 0, 4, 6, 0, 0, 0, 0, 6, 0, 0, 0, 1, 5, 0, 0, 0, 2, 5,…
    ## $ X.36            <dbl> 5, 2, 3, 0, 7, 0, 0, 0, 0, 2, 0, 0, 0, 0, 9, 3, 0, 0,…
    ## $ X.37            <dbl> 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 4, 0, 4, 0, 0, 0, 0,…
    ## $ X.38            <dbl> 1, 0, 0, 0, 3, 0, 4, 0, 0, 5, 0, 0, 0, 0, 4, 1, 0, 1,…
    ## $ X.39            <dbl> 12, 0, 2, 0, 5, 0, 0, 0, 0, 2, 0, 0, 2, 0, 6, 10, 5, …
    ## $ X.40            <dbl> 0, 2, 2, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 0, 0, 0, 2,…
    ## $ X.41            <dbl> 0, 28, 18, 46, 0, 0, 0, 26, 37, 1, 37, 0, 40, 0, 0, 0…
    ## $ X.42            <dbl> 0, 5, 2, 0, 0, 0, 0, 3, 0, 0, 0, 0, 5, 0, 0, 0, 5, 2,…
    ## $ X.43            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.44            <dbl> 0, 0, 0, 2, 0, 0, 0, 0, 5, 2, 4, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.45            <dbl> 10, 0, 0, 0, 9, 0, 0, 0, 0, 0, 1, 0, 0, 0, 11, 12, 0,…
    ## $ X.46            <dbl> 3, 0, 0, 5, 3, 0, 0, 0, 4, 0, 1, 0, 0, 0, 3, 1, 0, 0,…
    ## $ X.47            <dbl> 9, 0, 0, 29, 7, 14, 1, 1, 34, 0, 29, 10, 0, 12, 6, 6,…
    ## $ X.48            <dbl> 0, 0, 0, 6, 0, 32, 0, 0, 6, 5, 1, 37, 0, 35, 0, 0, 0,…
    ## $ X.49            <dbl> 9, 0, 0, 0, 10, 0, 0, 0, 0, 1, 0, 0, 0, 0, 5, 11, 0, …
    ## $ X.50            <dbl> 0, 0, 0, 14, 0, 0, 0, 0, 10, 1, 5, 0, 0, 0, 0, 0, 0, …
    ## $ X.51            <dbl> 3, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 0, 1, 2, 0, 0,…
    ## $ X.52            <dbl> 0, 8, 14, 7, 0, 7, 0, 7, 3, 0, 4, 6, 8, 5, 2, 4, 11, …
    ## $ X.53            <dbl> 0, 1, 1, 1, 0, 0, 0, 0, 4, 0, 1, 3, 1, 0, 0, 0, 3, 6,…
    ## $ X.54            <dbl> 0, 0, 0, 0, 0, 3, 0, 0, 0, 1, 1, 3, 0, 4, 0, 0, 0, 0,…
    ## $ X.55            <dbl> 0, 0, 0, 2, 0, 3, 0, 0, 0, 0, 0, 9, 0, 4, 0, 0, 0, 0,…
    ## $ X.56            <dbl> 0, 0, 0, 4, 0, 0, 1, 0, 3, 0, 5, 0, 1, 0, 0, 0, 1, 0,…
    ## $ X.57            <dbl> 33, 0, 0, 4, 35, 5, 0, 0, 2, 24, 1, 2, 0, 5, 32, 35, …
    ## $ X.58            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.59            <dbl> 2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0,…
    ## $ X.60            <dbl> 14, 0, 2, 0, 11, 1, 0, 1, 0, 0, 0, 0, 0, 0, 10, 15, 2…
    ## $ X.61            <dbl> 4, 0, 0, 0, 6, 0, 0, 0, 2, 0, 2, 0, 0, 0, 10, 4, 0, 0…
    ## $ X.62            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0,…
    ## $ X.63            <dbl> 0, 0, 0, 0, 0, 0, 6, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1,…
    ## $ X.64            <dbl> 1, 0, 0, 0, 0, 4, 2, 0, 1, 0, 0, 1, 0, 1, 2, 0, 0, 0,…
    ## $ X.65            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.66            <dbl> 0, 0, 0, 47, 0, 0, 0, 0, 46, 0, 38, 0, 0, 0, 0, 0, 0,…
    ## $ X.67            <dbl> 4, 0, 0, 0, 4, 0, 0, 0, 1, 7, 0, 0, 0, 0, 8, 10, 0, 1…
    ## $ X.68            <dbl> 0, 0, 1, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 0, 0, 0, 3, 0…
    ## $ X.69            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.70            <dbl> 1, 0, 0, 0, 0, 0, 17, 0, 4, 2, 2, 0, 0, 0, 1, 0, 0, 0…
    ## $ X.71            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.72            <dbl> 0, 0, 0, 0, 0, 0, 5, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 1,…
    ## $ X.73            <dbl> 0, 40, 38, 0, 0, 0, 0, 43, 0, 16, 0, 0, 41, 0, 0, 0, …
    ## $ X.74            <dbl> 5, 9, 15, 0, 17, 0, 0, 14, 1, 0, 1, 0, 9, 0, 12, 11, …
    ## $ X.75            <dbl> 0, 17, 16, 0, 0, 2, 0, 15, 0, 0, 0, 0, 15, 0, 0, 0, 1…
    ## $ X.76            <dbl> 0, 7, 5, 21, 0, 10, 0, 3, 27, 0, 33, 1, 3, 4, 0, 0, 5…
    ## $ X.77            <dbl> 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0,…
    ## $ X.78            <dbl> 0, 4, 8, 0, 0, 0, 0, 6, 0, 1, 0, 0, 2, 0, 0, 0, 6, 7,…
    ## $ X.79            <dbl> 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.80            <dbl> 1, 0, 0, 4, 1, 0, 7, 0, 4, 0, 2, 0, 0, 0, 2, 2, 0, 0,…
    ## $ X.81            <dbl> 6, 0, 0, 0, 12, 61, 0, 0, 0, 0, 0, 72, 0, 75, 9, 6, 0…
    ## $ X.82            <dbl> 3, 0, 0, 0, 1, 3, 0, 0, 0, 0, 0, 3, 0, 0, 2, 3, 0, 0,…
    ## $ X.83            <dbl> 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0,…
    ## $ X.84            <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.85            <dbl> 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.86            <dbl> 0, 29, 47, 0, 1, 0, 4, 39, 0, 1, 0, 0, 33, 0, 1, 0, 2…
    ## $ X.87            <dbl> 0, 0, 0, 0, 0, 0, 51, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0…
    ## $ X.88            <dbl> 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 7, 0, 5, 0, 0, 0, 0,…
    ## $ X.89            <dbl> 1, 0, 0, 2, 4, 0, 0, 2, 5, 2, 7, 0, 3, 0, 0, 1, 0, 0,…
    ## $ X.90            <dbl> 0, 0, 1, 0, 0, 10, 0, 1, 0, 1, 0, 6, 0, 2, 1, 1, 1, 0…
    ## $ X.91            <dbl> 0, 20, 25, 0, 0, 0, 0, 25, 1, 0, 0, 0, 31, 0, 0, 0, 2…
    ## $ X.92            <dbl> 0, 0, 2, 0, 0, 0, 0, 3, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.93            <dbl> 5, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 0, 0,…
    ## $ X.94            <dbl> 0, 0, 0, 8, 0, 1, 0, 0, 6, 8, 6, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.95            <dbl> 0, 0, 0, 0, 0, 0, 6, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.96            <dbl> 0, 0, 0, 2, 0, 19, 0, 0, 2, 0, 5, 7, 0, 18, 0, 0, 0, …
    ## $ X.97            <dbl> 3, 0, 0, 4, 5, 0, 0, 0, 6, 6, 5, 0, 0, 0, 1, 4, 0, 0,…
    ## $ X.98            <dbl> 6, 0, 0, 0, 8, 15, 14, 0, 1, 1, 2, 22, 0, 26, 8, 11, …
    ## $ X.99            <dbl> 0, 8, 9, 0, 0, 4, 33, 15, 0, 0, 0, 0, 17, 3, 0, 0, 17…
    ## $ X.100           <dbl> 0, 0, 0, 0, 0, 0, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
    ## $ X.101           <dbl> 0, 0, 0, 10, 0, 0, 0, 0, 6, 8, 14, 0, 0, 0, 0, 0, 1, …
    ## $ cum_reward_rate <dbl> 0.98251477, 0.01194671, 0.01668626, 0.02238859, 0.961…
    ## $ cum_regret_rate <dbl> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…
